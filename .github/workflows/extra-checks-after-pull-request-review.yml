name: post-review-checks

on:
  pull_request_review:
    types: [submitted]

  workflow_dispatch:

jobs:
  faker_docs:
    name: Faker Docs I18N
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2"
      - uses: "actions/setup-python@v1"
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -VV
          make dev-install
          python setup.py install

      - name: Make Docs
        run: make docs

  salesforce:
    name: Test with Salesforce
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2"
      - uses: "actions/setup-python@v1"
        with:
          python-version: "3.9"

      - name: "Install dependencies"
        run: |
          python -VV
          python -m pip install --upgrade pip pip-tools
          make dev-install

      - name: Install sfdx
        run: |
          mkdir sfdx
          wget -qO- https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz | tar xJ -C sfdx --strip-components 1
          echo $(realpath sfdx/bin) >> $GITHUB_PATH
      - name: Authenticate Dev Hub
        run: |
          sfdx plugins --core
          echo $SFDX_HUB_KEY_BASE64 | base64 --decode > sfdx.key
          sfdx auth:jwt:grant --clientid $SFDX_CLIENT_ID --jwtkeyfile sfdx.key --username $SFDX_HUB_USERNAME --setdefaultdevhubusername -a hub
        env:
          SFDX_HUB_KEY_BASE64: ${{ secrets.SFDX_HUB_KEY_BASE64 }}
          SFDX_CLIENT_ID: ${{ secrets.SFDX_CLIENT_ID }}
          SFDX_HUB_USERNAME: ${{ secrets.SFDX_HUB_USERNAME }}
      - name: Run Snowfakery Tests
        run: |
          cci flow run test_everything --org dev
      - name: Delete scratch org
        if: always()
        run: |
          cci org scratch_delete dev  salesforce:
    name: Test with Salesforce
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2"
      - uses: "actions/setup-python@v1"
        with:
          python-version: "3.9"

      - name: "Install dependencies"
        run: |
          python -VV
          python -m pip install --upgrade pip pip-tools
          make dev-install

      - name: Install sfdx
        run: |
          mkdir sfdx
          wget -qO- https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz | tar xJ -C sfdx --strip-components 1
          echo $(realpath sfdx/bin) >> $GITHUB_PATH
      - name: Authenticate Dev Hub
        run: |
          sfdx plugins --core
          echo $SFDX_HUB_KEY_BASE64 | base64 --decode > sfdx.key
          sfdx auth:jwt:grant --clientid $SFDX_CLIENT_ID --jwtkeyfile sfdx.key --username $SFDX_HUB_USERNAME --setdefaultdevhubusername -a hub
        env:
          SFDX_HUB_KEY_BASE64: ${{ secrets.SFDX_HUB_KEY_BASE64 }}
          SFDX_CLIENT_ID: ${{ secrets.SFDX_CLIENT_ID }}
          SFDX_HUB_USERNAME: ${{ secrets.SFDX_HUB_USERNAME }}
      - name: Run Snowfakery/CCI Flow Tests
        run: |
          cci flow run test_everything --org dev
      - name: Delete scratch org
        if: always()
        run: |
          cci org scratch_delete dev
      - name: Run Snowfakery VCR Tests
        run: |
          pytest --org dev
      - name: Delete scratch org
        if: always()
        run: |
          cci org scratch_delete dev